<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìœ„ ì‘ì› ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #333;
            margin-top: 0;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 0;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        input, select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }

        .log-area {
            height: 200px;
            overflow-y: auto;
            background-color: #f8f8f8;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .warning {
            color: orange;
        }

        .info {
            color: blue;
        }

        .cheer-count {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .cheer-button {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background-color: #ff5722;
        }

        .cheer-button:hover {
            background-color: #e64a19;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background-color: green;
        }

        .status-disconnected {
            background-color: red;
        }

        .status-connecting {
            background-color: orange;
        }

        .connection-status {
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>ì‹œìœ„ ì‘ì› ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>

<div class="connection-status">
    <span class="status-indicator status-disconnected" id="connection-indicator"></span>
    <span id="connection-status">ì—°ê²° ì•ˆë¨</span>
</div>

<div class="container">
    <div class="card">
        <h2>WebSocket ì—°ê²° ì„¤ì •</h2>
        <div>
            <label for="server-url">ì„œë²„ URL:</label>
            <input type="text" id="server-url" value="http://localhost:8080/api/ws">
        </div>
        <div>
            <label for="token">JWT í† í° (Bearer ì œì™¸):</label>
            <input type="text" id="token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>
        <div>
            <button id="connect-btn">ì—°ê²°</button>
            <button id="disconnect-btn" disabled>ì—°ê²° í•´ì œ</button>
        </div>
    </div>

    <div class="card">
        <h2>ì‹œìœ„ ì‘ì› í…ŒìŠ¤íŠ¸</h2>
        <div>
            <label for="protest-id">ì‹œìœ„ ID:</label>
            <input type="number" id="protest-id" value="60252" min="1">
        </div>
        <div>
            <button id="subscribe-btn" disabled>êµ¬ë…</button>
            <button id="unsubscribe-btn" disabled>êµ¬ë… í•´ì œ</button>
        </div>
        <div class="cheer-count" id="cheer-count">0</div>
        <button class="cheer-button" id="cheer-btn" disabled>ì‘ì›í•˜ê¸° ğŸ‘</button>
    </div>
</div>

<div class="card">
    <h2>REST API í…ŒìŠ¤íŠ¸</h2>
    <div>
        <button id="get-cheer-btn">ì‘ì› ìˆ˜ ì¡°íšŒ (GET)</button>
        <button id="post-cheer-btn">ì‘ì›í•˜ê¸° (POST)</button>
        <button id="get-all-cheers-btn">ëª¨ë“  ì‹œìœ„ ì‘ì› ìˆ˜ ì¡°íšŒ</button>
    </div>
    <div>
        <h3>ì‘ë‹µ ê²°ê³¼:</h3>
        <pre id="rest-result">ì•„ì§ ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</pre>
    </div>
</div>

<div class="card">
    <h2>ë¡œê·¸</h2>
    <button id="clear-log-btn">ë¡œê·¸ ì§€ìš°ê¸°</button>
    <div class="log-area" id="log-area"></div>
</div>

<!-- STOMPì™€ SockJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    // ìƒíƒœ ë³€ìˆ˜
    let stompClient = null;
    let subscription = null;

    // DOM ìš”ì†Œ
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const subscribeBtn = document.getElementById('subscribe-btn');
    const unsubscribeBtn = document.getElementById('unsubscribe-btn');
    const cheerBtn = document.getElementById('cheer-btn');
    const serverUrlInput = document.getElementById('server-url');
    const tokenInput = document.getElementById('token');
    const protestIdInput = document.getElementById('protest-id');
    const cheerCountElement = document.getElementById('cheer-count');
    const logArea = document.getElementById('log-area');
    const restResult = document.getElementById('rest-result');
    const clearLogBtn = document.getElementById('clear-log-btn');
    const getCheerBtn = document.getElementById('get-cheer-btn');
    const postCheerBtn = document.getElementById('post-cheer-btn');
    const getAllCheersBtn = document.getElementById('get-all-cheers-btn');
    const connectionStatus = document.getElementById('connection-status');
    const connectionIndicator = document.getElementById('connection-indicator');
    const baseURL = 'http://localhost:8080';

    // ë¡œê·¸ í•¨ìˆ˜
    function log(message, type = 'info') {
        const now = new Date();
        const timestamp = now.toISOString().split('T')[1].slice(0, -1);
        const logEntry = document.createElement('div');
        logEntry.classList.add(type);
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        logArea.appendChild(logEntry);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateConnectionStatus(status) {
        connectionStatus.textContent = status;
        connectionIndicator.className = 'status-indicator';

        switch (status) {
            case 'ì—°ê²°ë¨':
                connectionIndicator.classList.add('status-connected');
                break;
            case 'ì—°ê²° ì¤‘...':
                connectionIndicator.classList.add('status-connecting');
                break;
            default:
                connectionIndicator.classList.add('status-disconnected');
        }
    }

    // WebSocket ì—°ê²°
    connectBtn.addEventListener('click', function () {
        const serverUrl = serverUrlInput.value.trim();
        const token = tokenInput.value.trim();

        if (!serverUrl) {
            log('ì„œë²„ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        updateConnectionStatus('ì—°ê²° ì¤‘...');
        log(`WebSocket ì—°ê²° ì‹œë„: ${serverUrl}`);

        // SockJS ë° STOMP í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        const socket = new SockJS(serverUrl);
        stompClient = Stomp.over(socket);
        // stompClient.heartbeat.outgoing = 20000; // 20ì´ˆ
        // stompClient.heartbeat.incoming = 0;     // ì„œë²„ë¡œë¶€í„° heartbeat í•„ìš” ì—†ìŒ
        stompClient.debug = function (str) {
            console.log(str);
            log(str, 'info');
        };

        // ë””ë²„ê·¸ ë¡œê·¸ ë¹„í™œì„±í™”
        stompClient.debug = null;

        // ì—°ê²° í—¤ë” ì„¤ì • (JWT í† í° í¬í•¨)
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        // ì—°ê²° ì‹œë„
        stompClient.connect(
            headers,
            function (frame) {
                log(`WebSocket ì—°ê²° ì„±ê³µ: ${frame}`, 'success');
                updateConnectionStatus('ì—°ê²°ë¨');

                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                subscribeBtn.disabled = false;
                unsubscribeBtn.disabled = true;
                cheerBtn.disabled = true;
            },
            function (error) {
                log(`WebSocket ì—°ê²° ì‹¤íŒ¨: ${error}`, 'error');
                updateConnectionStatus('ì—°ê²° ì•ˆë¨');

                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                subscribeBtn.disabled = true;
                unsubscribeBtn.disabled = true;
                cheerBtn.disabled = true;
            }
        );
    });

    // WebSocket ì—°ê²° í•´ì œ
    disconnectBtn.addEventListener('click', function () {
        if (stompClient) {
            // êµ¬ë… í•´ì œ
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                log('í† í”½ êµ¬ë… í•´ì œë¨', 'info');
            }

            // ì—°ê²° í•´ì œ
            stompClient.disconnect(function () {
                log('WebSocket ì—°ê²° í•´ì œë¨', 'info');
                updateConnectionStatus('ì—°ê²° ì•ˆë¨');

                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                subscribeBtn.disabled = true;
                unsubscribeBtn.disabled = true;
                cheerBtn.disabled = true;

                // ì‘ì› ìˆ˜ ì´ˆê¸°í™”
                cheerCountElement.textContent = '0';
            });

            stompClient = null;
        }
    });

    // ì‹œìœ„ ì‘ì› í† í”½ êµ¬ë…
    subscribeBtn.addEventListener('click', function () {
        if (!stompClient) {
            log('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        const protestId = protestIdInput.value.trim();
        if (!protestId) {
            log('ì‹œìœ„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // ì´ë¯¸ êµ¬ë… ì¤‘ì´ë©´ í•´ì œ
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
            log('ê¸°ì¡´ í† í”½ êµ¬ë… í•´ì œë¨', 'info');
        }

        // ìƒˆ í† í”½ êµ¬ë…
        const topic = `/topic/cheer`;
        log(`í† í”½ êµ¬ë… ì‹œë„: ${topic}`);

        subscription = stompClient.subscribe(topic, function (message) {
            try {
                const response = JSON.parse(message.body);
                log(`ì‘ì› ì—…ë°ì´íŠ¸ ìˆ˜ì‹ : ${JSON.stringify(response)}`, 'success');

                // ì‘ì› ìˆ˜ ì—…ë°ì´íŠ¸
                cheerCountElement.textContent = response.cheerCount;
            } catch (error) {
                log(`ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error}`, 'error');
            }
        });

        stompClient.subscribe('/user/queue/errors', function (message) {
            try {
                const response = JSON.parse(message.body);
                log(`ì—ëŸ¬ ë°œìƒ: ${JSON.stringify(response.body)}`, 'error');
            } catch (error) {
                log(`ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error}`, 'error');
            }
        });

        log(`í† í”½ êµ¬ë… ì„±ê³µ: ${topic}`, 'success');

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        subscribeBtn.disabled = true;
        unsubscribeBtn.disabled = false;
        cheerBtn.disabled = false;

        // ì´ˆê¸° ì‘ì› ìˆ˜ ì¡°íšŒ
        fetchCheerCount();
    });

    // ì‹œìœ„ ì‘ì› í† í”½ êµ¬ë… í•´ì œ
    unsubscribeBtn.addEventListener('click', function () {
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
            log('í† í”½ êµ¬ë… í•´ì œë¨', 'info');

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            subscribeBtn.disabled = false;
            unsubscribeBtn.disabled = true;
            cheerBtn.disabled = true;

            // ì‘ì› ìˆ˜ ì´ˆê¸°í™”
            cheerCountElement.textContent = '0';
        }
    });

    // ì‹œìœ„ ì‘ì›í•˜ê¸° (WebSocket)
    cheerBtn.addEventListener('click', function () {
        if (!stompClient || !subscription) {
            log('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ê±°ë‚˜ í† í”½ì„ êµ¬ë…í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        const protestId = protestIdInput.value.trim();
        if (!protestId) {
            log('ì‹œìœ„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const destination = `/app/cheer/protest/${protestId}`;
        log(`ì‘ì› ë©”ì‹œì§€ ì „ì†¡: ${destination}`);

        // ì‘ì› ë©”ì‹œì§€ ì „ì†¡ (ë¹ˆ ë³¸ë¬¸)
        stompClient.send(destination, {}, JSON.stringify({}));
    });

    // REST APIë¡œ ì‘ì› ìˆ˜ ì¡°íšŒ
    getCheerBtn.addEventListener('click', function () {
        fetchCheerCount();
    });

    // REST APIë¡œ ì‘ì›í•˜ê¸°
    postCheerBtn.addEventListener('click', function () {
        const protestId = protestIdInput.value.trim();
        if (!protestId) {
            log('ì‹œìœ„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const url = `${baseURL}/api/cheer/protest/${protestId}`;
        const token = tokenInput.value.trim();
        const headers = {
            'Content-Type': 'application/json'
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        log(`POST ìš”ì²­ ì „ì†¡: ${url}`);

        fetch(url, {
            method: 'POST',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                log(`ì‘ì› ìš”ì²­ ì„±ê³µ: ${JSON.stringify(data)}`, 'success');
                restResult.textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                log(`ì‘ì› ìš”ì²­ ì‹¤íŒ¨: ${error}`, 'error');
                restResult.textContent = `ì˜¤ë¥˜: ${error.message}`;
            });
    });

    // REST APIë¡œ ëª¨ë“  ì‹œìœ„ ì‘ì› ìˆ˜ ì¡°íšŒ
    getAllCheersBtn.addEventListener('click', function () {
        const url = `${baseURL}/api/cheer/protest`;
        const token = tokenInput.value.trim();
        const headers = {};

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        log(`GET ìš”ì²­ ì „ì†¡: ${url}`);

        fetch(url, {
            method: 'GET',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                log(`ëª¨ë“  ì‹œìœ„ ì‘ì› ìˆ˜ ì¡°íšŒ ì„±ê³µ: ${data.length}ê°œ í•­ëª©`, 'success');
                restResult.textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                log(`ëª¨ë“  ì‹œìœ„ ì‘ì› ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨: ${error}`, 'error');
                restResult.textContent = `ì˜¤ë¥˜: ${error.message}`;
            });
    });

    // REST APIë¡œ ì‘ì› ìˆ˜ ì¡°íšŒ
    function fetchCheerCount() {
        const protestId = protestIdInput.value.trim();
        if (!protestId) {
            log('ì‹œìœ„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const url = `${baseURL}/api/cheer/protest/${protestId}`;
        const token = tokenInput.value.trim();
        const headers = {};

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        log(`GET ìš”ì²­ ì „ì†¡: ${url}`);

        fetch(url, {
            method: 'GET',
            headers: headers
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                log(`ì‘ì› ìˆ˜ ì¡°íšŒ ì„±ê³µ: ${JSON.stringify(data)}`, 'success');
                restResult.textContent = JSON.stringify(data, null, 2);
                cheerCountElement.textContent = data.data.cheerCount;
            })
            .catch(error => {
                log(`ì‘ì› ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨: ${error}`, 'error');
                restResult.textContent = `ì˜¤ë¥˜: ${error.message}`;
            });
    }

    // ë¡œê·¸ ì§€ìš°ê¸°
    clearLogBtn.addEventListener('click', function () {
        logArea.innerHTML = '';
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¤ì •
    window.addEventListener('load', function () {
        log('í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œëìŠµë‹ˆë‹¤.', 'info');
        log('WebSocket ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.', 'info');
    });
</script>
</body>
</html>